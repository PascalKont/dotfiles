{{- if eq .hosttype "work" "private" "full"}}
{{- if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash
set -euo pipefail

# Detect OS
OS=$(uname | tr '[:upper:]' '[:lower:]')
echo "Detected OS: $OS"

install_pinentry() {
  if command -v dnf &>/dev/null; then
    echo "Installing Pinentry via dnf..."
    sudo dnf install -y pinentry
  elif command -v apt-get &>/dev/null; then
    echo "Installing Pinentry via apt-get..."
    sudo apt-get update
    sudo apt-get install -y pinentry
  elif command -v yum &>/dev/null; then
    echo "Installing Pinentry via yum..."
    sudo yum install -y pinentry
  elif command -v pacman &>/dev/null; then
    echo "Installing Pinentry via pacman..."
    sudo pacman -Sy --noconfirm pinentry
  else
    echo "No supported package manager found. Please install Pinentry manually."
    exit 1
  fi

  # Verify installation
  if command -v pinentry &>/dev/null; then
    echo "Pinentry successfully installed."
  else
    echo "Pinentry installation failed."
    exit 1
  fi
}

# Check if trust.db is missing
if [ ! -f "~/.gnupg/trustdb.gpg" ]; then
  echo "GPG trust database not found. Initializing GPG..."
  gpg --list-keys >/dev/null 2>&1 || true

  # Check if Pinentry is missing
  if [ ! command -v pinentry ] &>/dev/null; then
    install_pinentry
  fi

  # Check if gpg.export exists and import keys
  if [ -f "~/gpg.export" ]; then
    echo "Importing GPG keys from gpg.export..."
    gpg --import "~/gpg.export"
    echo "GPG keys imported successfully."
  fi
fi

{{- end }}
{{- end }}
